name: CI - AnÃ¡lisis de CÃ³digo C++

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  cppcheck:
    name: AnÃ¡lisis EstÃ¡tico con CPPCheck
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Instalar CPPCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: ðŸ“Š Verificar versiÃ³n de CPPCheck
        run: cppcheck --version

      - name: ðŸ” Verificar estructura del proyecto
        run: |
          echo "ðŸ“ Estructura del repositorio:"
          find . -type f -name "*.cpp" -o -name "*.h" | head -20
          echo "ðŸ“ Directorios encontrados:"
          ls -la

      - name: ðŸ” Ejecutar anÃ¡lisis estÃ¡tico
        run: |
          echo "ðŸ” Ejecutando CPPCheck en el proyecto..."

          # Buscar todos los archivos C++ recursivamente
          CPP_FILES=$(find . -name "*.cpp" -not -path "./obj/*" -not -path "./.git/*")
          H_FILES=$(find . -name "*.h" -not -path "./obj/*" -not -path "./.git/*")

          if [ -z "$CPP_FILES" ] && [ -z "$H_FILES" ]; then
            echo "âŒ No se encontraron archivos .cpp o .h"
            exit 1
          fi

          echo "ðŸ“„ Archivos encontrados:"
          echo "CPP: $CPP_FILES"
          echo "Headers: $H_FILES"

          # Ejecutar cppcheck en los archivos encontrados
          cppcheck --enable=all \
                   --std=c++17 \
                   --platform=unix64 \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction \
                   --inline-suppr \
                   --error-exitcode=1 \
                   --xml \
                   --xml-version=2 \
                   $CPP_FILES $H_FILES 2> cppcheck-report.xml

      - name: ðŸ“‹ Mostrar reporte en consola
        if: always()
        run: |
          echo "ðŸ“‹ Reporte de CPPCheck:"

          # Buscar archivos nuevamente para el reporte en consola
          CPP_FILES=$(find . -name "*.cpp" -not -path "./obj/*" -not -path "./.git/*")
          H_FILES=$(find . -name "*.h" -not -path "./obj/*" -not -path "./.git/*")

          if [ ! -z "$CPP_FILES" ] || [ ! -z "$H_FILES" ]; then
            cppcheck --enable=all \
                     --std=c++17 \
                     --suppress=missingIncludeSystem \
                     --suppress=unusedFunction \
                     $CPP_FILES $H_FILES
          fi

      - name: ðŸ“„ Subir reporte XML como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.xml
          retention-days: 30

  build-test:
    name: CompilaciÃ³n y Pruebas
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make

      - name: ðŸ” Verificar archivos del proyecto
        run: |
          echo "ðŸ“ Contenido del repositorio:"
          ls -la
          echo "ðŸ“„ Archivos C++:"
          find . -name "*.cpp" -o -name "*.h"
          echo "ðŸ“ Makefile presente:"
          ls -la Makefile 2>/dev/null || echo "âŒ Makefile no encontrado"

      - name: ðŸ“ Crear directorios necesarios
        run: |
          mkdir -p obj data

      - name: ðŸ—ï¸ Compilar proyecto
        run: |
          echo "ðŸ—ï¸ Compilando proyecto..."
          if [ -f Makefile ]; then
            make clean || true
            make
          else
            echo "âŒ Makefile no encontrado, compilando manualmente..."
            # CompilaciÃ³n manual como fallback
            g++ -std=c++17 -Wall -Wextra -g -I. $(find . -name "*.cpp") -o biblioteca
          fi

      - name: ðŸ“‹ Configurar datos de prueba
        run: |
          echo "ðŸ“‹ Configurando datos de prueba..."
          if [ -f Makefile ]; then
            make setup-data || echo "âš ï¸ setup-data no disponible"
          else
            mkdir -p data
            echo "LIBRO|Test Book|Test Author|1234567890123|2023|1|1|Fiction|100" > data/materiales.txt
            echo "Test User|12345678|test@test.com|5|" > data/usuarios.txt
            touch data/prestamos.txt
          fi

      - name: âœ… Verificar ejecutable
        run: |
          echo "âœ… Verificando que el ejecutable se creÃ³ correctamente..."
          if [ -f biblioteca ]; then
            ls -la biblioteca
            file biblioteca
          else
            echo "âŒ Ejecutable no encontrado"
            ls -la
          fi

      - name: ðŸ§ª Ejecutar prueba bÃ¡sica
        run: |
          echo "ðŸ§ª Ejecutando prueba bÃ¡sica del programa..."
          if [ -f biblioteca ]; then
            echo "9" | timeout 10s ./biblioteca || echo "Prueba completada con timeout"
          else
            echo "âš ï¸ No se puede probar - ejecutable no encontrado"
          fi

  code-quality:
    name: AnÃ¡lisis de Calidad Adicional
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“Š Contar lÃ­neas de cÃ³digo
        run: |
          echo "ðŸ“Š EstadÃ­sticas del proyecto:"
          echo "Total de archivos C++:"
          find . -name "*.cpp" -o -name "*.h" | wc -l
          echo "LÃ­neas de cÃ³digo:"
          find . -name "*.cpp" -o -name "*.h" | xargs wc -l 2>/dev/null | tail -1 || echo "Sin archivos para contar"
          echo "Archivos por tipo:"
          echo "Headers (.h):" 
          find . -name "*.h" | wc -l
          echo "Implementaciones (.cpp):"
          find . -name "*.cpp" | wc -l

      - name: ðŸ” Verificar estructura del proyecto
        run: |
          echo "ðŸ” Verificando estructura del proyecto..."
          echo "Estructura completa:"
          tree . 2>/dev/null || find . -type d | head -10
          echo "Archivos principales:"
          ls -la *.cpp *.md Makefile 2>/dev/null || echo "Algunos archivos no encontrados"
