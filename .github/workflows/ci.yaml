name: CI - AnÃ¡lisis de CÃ³digo C++

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  cppcheck:
    name: AnÃ¡lisis EstÃ¡tico con CPPCheck
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Instalar CPPCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: ðŸ“Š Verificar versiÃ³n de CPPCheck
        run: cppcheck --version

      - name: ðŸ” Ejecutar anÃ¡lisis estÃ¡tico
        run: |
          echo "ðŸ” Ejecutando CPPCheck en el proyecto..."
          cppcheck --enable=all \
                   --std=c++17 \
                   --platform=unix64 \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction \
                   --inline-suppr \
                   --error-exitcode=1 \
                   --xml \
                   --xml-version=2 \
                   src/ include/ main.cpp 2> cppcheck-report.xml

      - name: ðŸ“‹ Mostrar reporte en consola
        if: always()
        run: |
          echo "ðŸ“‹ Reporte de CPPCheck:"
          cppcheck --enable=all \
                   --std=c++17 \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction \
                   src/ include/ main.cpp

      - name: ðŸ“„ Subir reporte XML como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.xml
          retention-days: 30

  build-test:
    name: CompilaciÃ³n y Pruebas
    runs-on: ubuntu-latest
    needs: cppcheck

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make

      - name: ðŸ“ Crear directorios necesarios
        run: |
          mkdir -p obj data

      - name: ðŸ—ï¸ Compilar proyecto
        run: |
          echo "ðŸ—ï¸ Compilando proyecto..."
          make clean
          make

      - name: ðŸ“‹ Configurar datos de prueba
        run: |
          echo "ðŸ“‹ Configurando datos de prueba..."
          make setup-data

      - name: âœ… Verificar ejecutable
        run: |
          echo "âœ… Verificando que el ejecutable se creÃ³ correctamente..."
          ls -la biblioteca
          file biblioteca

      - name: ðŸ§ª Ejecutar prueba bÃ¡sica
        run: |
          echo "ðŸ§ª Ejecutando prueba bÃ¡sica del programa..."
          echo "9" | timeout 10s ./biblioteca || true
          echo "Prueba completada"

  code-quality:
    name: AnÃ¡lisis de Calidad Adicional
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“Š Contar lÃ­neas de cÃ³digo
        run: |
          echo "ðŸ“Š EstadÃ­sticas del proyecto:"
          echo "Total de archivos:"
          find . -name "*.cpp" -o -name "*.h" | wc -l
          echo "LÃ­neas de cÃ³digo:"
          find . -name "*.cpp" -o -name "*.h" | xargs wc -l | tail -1
          echo "Archivos por tipo:"
          echo "Headers (.h):" 
          find . -name "*.h" | wc -l
          echo "Implementaciones (.cpp):"
          find . -name "*.cpp" | wc -l

      - name: ðŸ” Verificar estructura del proyecto
        run: |
          echo "ðŸ” Verificando estructura del proyecto..."
          echo "Directorios esperados:"
          ls -la | grep "^d"
          echo "Archivos principales:"
          ls -la *.cpp *.md Makefile 2>/dev/null || true
          echo "Headers en include/:"
          ls -la include/ 2>/dev/null || true
          echo "Implementaciones en src/:"
          ls -la src/ 2>/dev/null || true
